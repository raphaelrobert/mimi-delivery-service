<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>MIMI Delivery Service</title>
<meta content="Raphael Robert" name="author">
<meta content="Konrad Kohbrok" name="author">
<meta content="
       This document describes the MIMI Delivery Service. 
    " name="description">
<meta content="xml2rfc 3.18.0" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-robert-mimi-delivery-service-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.18.0
    Python 3.11.5
    ConfigArgParse 1.5.3
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 3.10.0
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.31.0
    setuptools 67.7.2
    six 1.16.0
    wcwidth 0.2.6
-->
<link href="draft-robert-mimi-delivery-service.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMI</td>
<td class="right">September 2023</td>
</tr></thead>
<tfoot><tr>
<td class="left">Robert &amp; Kohbrok</td>
<td class="center">Expires 24 March 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-robert-mimi-delivery-service-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2023-09-21" class="published">21 September 2023</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-03-24">24 March 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">MIMI Delivery Service</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes the MIMI Delivery Service.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 24 March 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2023 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-terminology" class="internal xref">Terminology</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-architecture-and-protocol-o" class="internal xref">Architecture and protocol overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-client-to-server-and-server" class="internal xref">Client to server and server to server protocol</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-transport-for-the-mimi-ds-p" class="internal xref">Transport for the MIMI DS protocol</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-flow" class="internal xref">Flow</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-supported-operations" class="internal xref">Supported operations</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-client-removals-induced-by-" class="internal xref">Client removals induced by the Delivery Service</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.6">
                <p id="section-toc.1-1.3.2.6.1"><a href="#section-3.6" class="auto internal xref">3.6</a>.  <a href="#name-serialization-format" class="internal xref">Serialization format</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.7">
                <p id="section-toc.1-1.3.2.7.1"><a href="#section-3.7" class="auto internal xref">3.7</a>.  <a href="#name-keypackages" class="internal xref">KeyPackages</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.7.2.1">
                    <p id="section-toc.1-1.3.2.7.2.1.1"><a href="#section-3.7.1" class="auto internal xref">3.7.1</a>.  <a href="#name-connection-keypackages" class="internal xref">Connection KeyPackages</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.8">
                <p id="section-toc.1-1.3.2.8.1"><a href="#section-3.8" class="auto internal xref">3.8</a>.  <a href="#name-enqueue-authorization" class="internal xref">Enqueue authorization</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.9">
                <p id="section-toc.1-1.3.2.9.1"><a href="#section-3.9" class="auto internal xref">3.9</a>.  <a href="#name-clients-and-users" class="internal xref">Clients and users</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.10">
                <p id="section-toc.1-1.3.2.10.1"><a href="#section-3.10" class="auto internal xref">3.10</a>. <a href="#name-version-agility" class="internal xref">Version agility</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.11">
                <p id="section-toc.1-1.3.2.11.1"><a href="#section-3.11" class="auto internal xref">3.11</a>. <a href="#name-group-lifecycle" class="internal xref">Group lifecycle</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-security-properties-overvie" class="internal xref">Security properties overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-mls-based-security-properti" class="internal xref">MLS-based security properties</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-queue-authorization" class="internal xref">Queue Authorization</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-framing-and-processing-over" class="internal xref">Framing and processing overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-client-to-server-requests" class="internal xref">Client to server requests</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-server-to-server-requests" class="internal xref">Server to server requests</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="auto internal xref">5.3</a>.  <a href="#name-keypackages-2" class="internal xref">KeyPackages</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-connection-establishment-fl" class="internal xref">Connection establishment flow</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-ds-assisted-joining" class="internal xref">DS assisted joining</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-proposals-and-ds-initiated-" class="internal xref">Proposals and DS-initiated operations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-ds-initiated-operations" class="internal xref">DS-initiated operations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-client-removals" class="internal xref">Client removals</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="auto internal xref">9.2</a>.  <a href="#name-client-additions" class="internal xref">Client additions</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-client-initiated-operations" class="internal xref">Client-initiated operations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="auto internal xref">10.1</a>.  <a href="#name-request-group-id" class="internal xref">Request group id</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="auto internal xref">10.2</a>.  <a href="#name-create-group" class="internal xref">Create group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="auto internal xref">10.3</a>.  <a href="#name-delete-group" class="internal xref">Delete group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.4">
                <p id="section-toc.1-1.10.2.4.1"><a href="#section-10.4" class="auto internal xref">10.4</a>.  <a href="#name-add-users-to-a-group" class="internal xref">Add users to a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.5">
                <p id="section-toc.1-1.10.2.5.1"><a href="#section-10.5" class="auto internal xref">10.5</a>.  <a href="#name-remove-users-from-a-group" class="internal xref">Remove users from a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.6">
                <p id="section-toc.1-1.10.2.6.1"><a href="#section-10.6" class="auto internal xref">10.6</a>.  <a href="#name-add-clients-to-a-group" class="internal xref">Add clients to a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.7">
                <p id="section-toc.1-1.10.2.7.1"><a href="#section-10.7" class="auto internal xref">10.7</a>.  <a href="#name-remove-clients-from-a-group" class="internal xref">Remove clients from a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.8">
                <p id="section-toc.1-1.10.2.8.1"><a href="#section-10.8" class="auto internal xref">10.8</a>.  <a href="#name-self-remove-a-client-from-a" class="internal xref">Self remove a client from a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.9">
                <p id="section-toc.1-1.10.2.9.1"><a href="#section-10.9" class="auto internal xref">10.9</a>.  <a href="#name-update-a-client-in-a-group" class="internal xref">Update a client in a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10">
                <p id="section-toc.1-1.10.2.10.1"><a href="#section-10.10" class="auto internal xref">10.10</a>. <a href="#name-join-the-group-using-an-ext" class="internal xref">Join the group using an external commit</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.11">
                <p id="section-toc.1-1.10.2.11.1"><a href="#section-10.11" class="auto internal xref">10.11</a>. <a href="#name-send-an-application-message" class="internal xref">Send an application message to a group</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.12">
                <p id="section-toc.1-1.10.2.12.1"><a href="#section-10.12" class="auto internal xref">10.12</a>. <a href="#name-fetch-the-ds-signature-publ" class="internal xref">Fetch the DS' signature public key</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.13">
                <p id="section-toc.1-1.10.2.13.1"><a href="#section-10.13" class="auto internal xref">10.13</a>. <a href="#name-fetch-keypackages-of-one-or" class="internal xref">Fetch KeyPackages of one or more clients</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.14">
                <p id="section-toc.1-1.10.2.14.1"><a href="#section-10.14" class="auto internal xref">10.14</a>. <a href="#name-fetch-connection-keypackage" class="internal xref">Fetch connection KeyPackages of one or more clients</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.15">
                <p id="section-toc.1-1.10.2.15.1"><a href="#section-10.15" class="auto internal xref">10.15</a>. <a href="#name-reinitialize-a-group" class="internal xref">ReInitialize a group</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-dsfanoutrequests-and-ds-to-" class="internal xref">DSFanoutRequests and DS-to-DS authentication</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-role-based-access-control-i" class="internal xref">Role-based access control in groups</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="auto internal xref">13</a>. <a href="#name-rate-limiting-and-spam-prev" class="internal xref">Rate-limiting and spam prevention</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="auto internal xref">14</a>. <a href="#name-abusive-and-illegal-content" class="internal xref">Abusive and illegal content</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15" class="auto internal xref">15</a>. <a href="#name-security-considerations" class="internal xref">Security considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.1">
                <p id="section-toc.1-1.15.2.1.1"><a href="#section-15.1" class="auto internal xref">15.1</a>.  <a href="#name-transport-security" class="internal xref">Transport Security</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-16" class="auto internal xref">16</a>. <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The MLS protocol document specifies a protocol between two or more clients. The
MLS architecture document introduces an abstract concept of a "Delivery Service"
(DS) that is specifically responsible for ordering handshake messages and more
generally for delivering messages to the intended recipients.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document describes a Delivery Service that performs the mandated ordering
of handshake messages and uses MLS to implement a variety of other features:<a href="#section-1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-3.1">A protocol between clients and the Delivery Service that allows clients to
interact with the Delivery Service, including the specific wire format of the
messages. The protocol is specifically designed to be operated in a
decentralized, federated architecture but can be used in single instances as
well.<a href="#section-1-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.2">Assistance for new joiners of a group: The Delivery Service can keep and
update state such as the public ratchet tree, group extensions, etc.<a href="#section-1-3.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.3">Message validation: The Delivery Service can inspect and validate handshake
messages and reject malformed, invalid or malicious messages.<a href="#section-1-3.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.4">Built-in authentication of group members and policy enforcement: The Delivery
Service can authenticate group members, reject messages from non-members and
enforce group administration policies. Additionally, the Delivery Service can
be linked to the Authentication Service to enforce more policies and
validation rules.<a href="#section-1-3.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.5">Scalability: The protocol makes no assumption about whether the Delivery Service
runs as a single instance or as a cluster of instances.<a href="#section-1-3.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.6">Network fluid: While the Delivery Service would typically run as a
server-side component, the only requirement is that it is accessible by all
clients.<a href="#section-1-3.6" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.7">Transport agnostic: Messages between clients and the Delivery Service can be
sent via an arbitrary transport protocol. Additionally, in the federated
case, client messages to a guest Delivery Service can be forwarded by a
client's local instance of this service.<a href="#section-1-3.7" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.8">Multi-device capable: The Delivery Service can be used by multiple devices
of the same users and supports adding and removing devices of a user.<a href="#section-1-3.8" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.9">A Queueing Service subcomponent that can be used to implement a queueing
service for messages that are delivered asynchronously, particularly in
federated environments, as well as the protocol between the Delivery Service
and the Queueing Service.<a href="#section-1-3.9" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-1-4">TODO: Make use of MUST/SHOULD, etc. throughout.<a href="#section-1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="terminology">
<section id="section-2">
      <h2 id="name-terminology">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
      </h2>
<p id="section-2-1">This document uses the terminology defined in <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span> with
the following additions:<a href="#section-2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-2.1">DS Domain: Fully qualified domain name as defined in RFC 2181 that represents
the DS. This does not necessarily have to be the domain under which the DS is
reachable on the network. Discovering that domain is the responsibility of the
MIMI transport protocol over which the MIMI DS protocol runs.
TODO: User/client/identifiers definitions are preliminary.<a href="#section-2-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.2">User: An entity that operates zero or more clients.<a href="#section-2-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.3">User identifier: An identifier that is unique in the scope of its DS and that
allows resolution to the providers DS domain.<a href="#section-2-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.4">Participant: A user that is participating in a group. If the participant has a
client in the group, it is called an active participant.<a href="#section-2-2.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.5">Client: An MLS client with a unique client identifier.<a href="#section-2-2.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.6">Client identifier: An octet string that uniquely identifies the client. A
client identifier includes the identifier of its user or otherwise allows the
association between the client and its user.<a href="#section-2-2.6" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.7">Connection: An agreement between two users, where each user authorizes the
other to send them messages and to add them to groups.<a href="#section-2-2.7" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.8">Connection establishment: The process by which a connection between two users
is established. The process is manually initiated by one user and fetching the
key material of the other user. The other user must be able to authenticate
the initiator and manually authorize the response.<a href="#section-2-2.8" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.9">Connection group: An MLS group consisting of the clients of two users. For
each pair of users, there can only be one connection group between them. A
connection group is created when one user requests a connection with another
user, followed by that user's consent.<a href="#section-2-2.9" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="architecture-and-protocol-overview">
<section id="section-3">
      <h2 id="name-architecture-and-protocol-o">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-architecture-and-protocol-o" class="section-name selfRef">Architecture and protocol overview</a>
      </h2>
<p id="section-3-1">The MIMI DS protocol allows interoperability between a hub which hosts a
group conversation and one or more guest DSs which are home to one or more of
the conversation's group members. Underlying each group conversation is an MLS
group that facilitates end-to-end encryption and authentication between group
members.<a href="#section-3-1" class="pilcrow">¶</a></p>
<p id="section-3-2">The main purpose of the MIMI DS protocol thus is to ensure that guest clients
can participate in the group. With MLS as the underlying protocol, this means
that the MIMI DS protocol is primarily concerned with the fan-out of MLS
messages (both from and to guest clients), as well the assistance of guest
clients in joining MLS groups.<a href="#section-3-2" class="pilcrow">¶</a></p>
<p id="section-3-3">The MIMI DS protocol requires clients to send MLS messages as PublicMessages
(with the exception of messages with content type <code>application</code>). This allows
the hub to track the MLS group state in the same way as a client would,
enabling it to keep an up-to-date and fully authenticated list of members, as
well as provide the full MLS group state to joining group members, even for
those joining via external commit. In addition, the DS can verify messages and
enforce access control policies on group operations.<a href="#section-3-3" class="pilcrow">¶</a></p>
<div id="c2s">
<section id="section-3.1">
        <h3 id="name-client-to-server-and-server">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-client-to-server-and-server" class="section-name selfRef">Client to server and server to server protocol</a>
        </h3>
<p id="section-3.1-1">MLS being a protocol for end-to-end encryption, a subset of MIMI DS protocol
messages have to originate from the clients rather than the interoperating
delivery services.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">The MIMI DS protocol consists of two parts: A client-to-server part that allows
guest clients to interact with the hub of one of their groups and a
server-to-server protocol that allows a hub to fan out messages to guest
DSs, which can subsequently store and forward messages to their respective
clients.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1-3">Note that the client-to-server part of the protocol can optionally be proxied
via the guest DS of the sending client.<a href="#section-3.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="transport-for-the-mimi-ds-protocol">
<section id="section-3.2">
        <h3 id="name-transport-for-the-mimi-ds-p">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-transport-for-the-mimi-ds-p" class="section-name selfRef">Transport for the MIMI DS protocol</a>
        </h3>
<p id="section-3.2-1">The MIMI DS protocol requires a transport protocol that provides confidentiality
of messages and that allows the discovery of a DS based on the DS domain in a
user identifier.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The client-to-server part of the MIMI DS protocol provide sender authentication.
Recipient authentication, as well as mutual server-to-server authentication is
left to the MIMI transport protocol.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow">
<section id="section-3.3">
        <h3 id="name-flow">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-flow" class="section-name selfRef">Flow</a>
        </h3>
<span id="name-architecture-overview"></span><div id="full-sending-flow">
<figure id="figure-1">
          <div id="section-3.3-1.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-1.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="416" width="480" viewBox="0 0 480 416" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,112" fill="none" stroke="black"></path>
                <path d="M 120,32 L 120,112" fill="none" stroke="black"></path>
                <path d="M 240,32 L 240,112" fill="none" stroke="black"></path>
                <path d="M 240,176 L 240,256" fill="none" stroke="black"></path>
                <path d="M 240,320 L 240,400" fill="none" stroke="black"></path>
                <path d="M 264,112 L 264,168" fill="none" stroke="black"></path>
                <path d="M 264,256 L 264,312" fill="none" stroke="black"></path>
                <path d="M 336,120 L 336,176" fill="none" stroke="black"></path>
                <path d="M 336,264 L 336,320" fill="none" stroke="black"></path>
                <path d="M 360,32 L 360,112" fill="none" stroke="black"></path>
                <path d="M 360,176 L 360,256" fill="none" stroke="black"></path>
                <path d="M 360,320 L 360,400" fill="none" stroke="black"></path>
                <path d="M 8,32 L 120,32" fill="none" stroke="black"></path>
                <path d="M 240,32 L 360,32" fill="none" stroke="black"></path>
                <path d="M 120,48 L 232,48" fill="none" stroke="black"></path>
                <path d="M 128,96 L 240,96" fill="none" stroke="black"></path>
                <path d="M 8,112 L 120,112" fill="none" stroke="black"></path>
                <path d="M 240,112 L 360,112" fill="none" stroke="black"></path>
                <path d="M 240,176 L 360,176" fill="none" stroke="black"></path>
                <path d="M 240,256 L 360,256" fill="none" stroke="black"></path>
                <path d="M 240,320 L 360,320" fill="none" stroke="black"></path>
                <path d="M 240,400 L 360,400" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="344,264 332,258.4 332,269.6" fill="black" transform="rotate(270,336,264)"></polygon>
                <polygon class="arrowhead" points="344,120 332,114.4 332,125.6" fill="black" transform="rotate(270,336,120)"></polygon>
                <polygon class="arrowhead" points="272,312 260,306.4 260,317.6" fill="black" transform="rotate(90,264,312)"></polygon>
                <polygon class="arrowhead" points="272,168 260,162.4 260,173.6" fill="black" transform="rotate(90,264,168)"></polygon>
                <polygon class="arrowhead" points="240,48 228,42.4 228,53.6" fill="black" transform="rotate(0,232,48)"></polygon>
                <polygon class="arrowhead" points="136,96 124,90.4 124,101.6" fill="black" transform="rotate(180,128,96)"></polygon>
                <g class="text">
                  <text x="48" y="68">Sending</text>
                  <text x="180" y="68">(proprietary</text>
                  <text x="272" y="68">Guest</text>
                  <text x="308" y="68">DS</text>
                  <text x="44" y="84">Client</text>
                  <text x="184" y="84">protocol)</text>
                  <text x="216" y="148">DSRequest</text>
                  <text x="388" y="148">DSResponse</text>
                  <text x="264" y="212">Hub</text>
                  <text x="192" y="292">DSFanoutRequest</text>
                  <text x="412" y="292">DSFanoutResponse</text>
                  <text x="272" y="356">Guest</text>
                  <text x="308" y="356">DS</text>
                </g>
              </svg><a href="#section-3.3-1.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-architecture-overview" class="selfRef">Architecture overview</a>
          </figcaption></figure>
</div>
<p id="section-3.3-2"><a href="#full-sending-flow" class="auto internal xref">Figure 1</a> shows an example protocol flow, where a client sends a
request to its own guest DS, which in turn makes a request to the hub. The
hub then fans out a message to another guest DS.<a href="#section-3.3-2" class="pilcrow">¶</a></p>
<p id="section-3.3-3">Both the message sending and the fanout parts of the protocol are designed in a
request/response pattern. In the first protocol part, the client sends a
DSRequest message to the Delivery Service and the Delivery Service responds with
a DSResponse message. This pattern can easily be used over e.g. RESTful APIs.<a href="#section-3.3-3" class="pilcrow">¶</a></p>
<span id="name-delivery-service-request-re"></span><figure id="figure-2">
          <div id="section-3.3-4.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-4.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="160" width="168" viewBox="0 0 168 160" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,48 L 8,144" fill="none" stroke="black"></path>
                <path d="M 144,48 L 144,144" fill="none" stroke="black"></path>
                <path d="M 8,80 L 136,80" fill="none" stroke="black"></path>
                <path d="M 16,128 L 144,128" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="144,80 132,74.4 132,85.6" fill="black" transform="rotate(0,136,80)"></polygon>
                <polygon class="arrowhead" points="24,128 12,122.4 12,133.6" fill="black" transform="rotate(180,16,128)"></polygon>
                <g class="text">
                  <text x="28" y="36">Client</text>
                  <text x="152" y="36">Hub</text>
                  <text x="56" y="68">DSRequest</text>
                  <text x="60" y="116">DSResponse</text>
                </g>
              </svg><a href="#section-3.3-4.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-delivery-service-request-re" class="selfRef">Delivery Service Request/Response scheme</a>
          </figcaption></figure>
<p id="section-3.3-5">For the second part of the protocol the Delivery Service sends a DSFanoutRequest
to each guest DS. This happens whenever a message needs to be fanned out to all
other members of a group as a result of an incoming DSRequest. The guest DS in
turn responds with a DSFanoutResponse.<a href="#section-3.3-5" class="pilcrow">¶</a></p>
<span id="name-client-delivery-service-com"></span><figure id="figure-3">
          <div id="section-3.3-6.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-6.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="240" width="592" viewBox="0 0 592 240" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,48 L 8,224" fill="none" stroke="black"></path>
                <path d="M 144,48 L 144,224" fill="none" stroke="black"></path>
                <path d="M 416,48 L 416,224" fill="none" stroke="black"></path>
                <path d="M 8,80 L 136,80" fill="none" stroke="black"></path>
                <path d="M 16,128 L 144,128" fill="none" stroke="black"></path>
                <path d="M 144,160 L 408,160" fill="none" stroke="black"></path>
                <path d="M 152,208 L 416,208" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="416,160 404,154.4 404,165.6" fill="black" transform="rotate(0,408,160)"></polygon>
                <polygon class="arrowhead" points="160,208 148,202.4 148,213.6" fill="black" transform="rotate(180,152,208)"></polygon>
                <polygon class="arrowhead" points="144,80 132,74.4 132,85.6" fill="black" transform="rotate(0,136,80)"></polygon>
                <polygon class="arrowhead" points="24,128 12,122.4 12,133.6" fill="black" transform="rotate(180,16,128)"></polygon>
                <g class="text">
                  <text x="28" y="36">Client</text>
                  <text x="152" y="36">Hub</text>
                  <text x="432" y="36">Guest</text>
                  <text x="492" y="36">Delivery</text>
                  <text x="560" y="36">Service</text>
                  <text x="56" y="68">DSRequest</text>
                  <text x="60" y="116">DSResponse</text>
                  <text x="216" y="148">DSFanoutRequest</text>
                  <text x="220" y="196">DSFanoutResponse</text>
                </g>
              </svg><a href="#section-3.3-6.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-client-delivery-service-com" class="selfRef">Client/Delivery Service communication with fanout</a>
          </figcaption></figure>
</section>
</div>
<div id="supported-operations">
<section id="section-3.4">
        <h3 id="name-supported-operations">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-supported-operations" class="section-name selfRef">Supported operations</a>
        </h3>
<p id="section-3.4-1">The MIMI DS protocol allows guest clients to request a variety of operations for
example to manage group membership, join groups, or send messages.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.4-2.1">Group creation/deletion<a href="#section-3.4-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.2">Join a group from a Welcome message as a new member<a href="#section-3.4-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.3">Join a group through an External Commit message as a new member
or client of an existing member (e.g. Resync a client after state loss)<a href="#section-3.4-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.4">Adding and removing users to/from a group<a href="#section-3.4-2.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.5">Adding and removing clients to/from a member of the group<a href="#section-3.4-2.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.6">Client updates (MLS leaf updates)<a href="#section-3.4-2.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.7">Sending application messages<a href="#section-3.4-2.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.8">Download of KeyPackages<a href="#section-3.4-2.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.9">Enqueueing of a message fanned out from an hub<a href="#section-3.4-2.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.4-2.10">Download of connection-specific KeyPackages<a href="#section-3.4-2.10" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="client-removals-induced-by-the-delivery-service">
<section id="section-3.5">
        <h3 id="name-client-removals-induced-by-">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-client-removals-induced-by-" class="section-name selfRef">Client removals induced by the Delivery Service</a>
        </h3>
<p id="section-3.5-1">Independent of client requests, the Delivery Service itself can remove clients
from a group by issuing remove proposals in the following cases:<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5-2.1">A user has removed a client from its account<a href="#section-3.5-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.5-2.2">A user has been deleted<a href="#section-3.5-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.5-2.3">The client is removed from the group because it has been inactive for too
long<a href="#section-3.5-2.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="serialization-format">
<section id="section-3.6">
        <h3 id="name-serialization-format">
<a href="#section-3.6" class="section-number selfRef">3.6. </a><a href="#name-serialization-format" class="section-name selfRef">Serialization format</a>
        </h3>
<p id="section-3.6-1">MLS messages use the presentation language and encoding format defined in
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> with the extensions defined in the MLS protocol specification. The
MIMI DS protocol uses the same serialization format, as both clients and DS
already have to support it to process MLS messages.<a href="#section-3.6-1" class="pilcrow">¶</a></p>
<p id="section-3.6-2">Octet strings resulting from serialization in this format are unambiguous and
require no further canonicalization.<a href="#section-3.6-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="keypackages">
<section id="section-3.7">
        <h3 id="name-keypackages">
<a href="#section-3.7" class="section-number selfRef">3.7. </a><a href="#name-keypackages" class="section-name selfRef">KeyPackages</a>
        </h3>
<p id="section-3.7-1">Clients have to upload KeyPackages such that others can add them to groups. In
the context of interoperability, this means that clients have to be able to
download KeyPackages of clients belonging to other DSs.<a href="#section-3.7-1" class="pilcrow">¶</a></p>
<p id="section-3.7-2">The MIMI DS protocol allows clients to download the KeyPackages of other
clients. Uploading KeyPackages is outside of the scope of this protocol, as it
is not relevant for interoperability.<a href="#section-3.7-2" class="pilcrow">¶</a></p>
<p id="section-3.7-3">TODO: KeyPackages of last resort should be marked. Ideally by using a KeyPackage
extension.<a href="#section-3.7-3" class="pilcrow">¶</a></p>
<div id="connection-keypackages">
<section id="section-3.7.1">
          <h4 id="name-connection-keypackages">
<a href="#section-3.7.1" class="section-number selfRef">3.7.1. </a><a href="#name-connection-keypackages" class="section-name selfRef">Connection KeyPackages</a>
          </h4>
<p id="section-3.7.1-1">In addition to regular KeyPackages, the MIMI DS protocol requires clients to
provide connection KeyPackages for other clients to download. Connection
KeyPackages are meant for use in the connection establishment process (explained
in more detail in <a href="#connection-establishment-flow" class="auto internal xref">Section 6</a>) and differ from regular
KeyPackages only in that they include a LeafNode extension marking them as such.<a href="#section-3.7.1-1" class="pilcrow">¶</a></p>
<p id="section-3.7.1-2">TODO: Such an extension would have to be specified in the context of the MLS WG.<a href="#section-3.7.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="enqueue-authorization">
<section id="section-3.8">
        <h3 id="name-enqueue-authorization">
<a href="#section-3.8" class="section-number selfRef">3.8. </a><a href="#name-enqueue-authorization" class="section-name selfRef">Enqueue authorization</a>
        </h3>
<p id="section-3.8-1">TODO: This section sketches an authorization mechanism based on a KeyPackage
extension. That extension would have to be defined in the context of the MLS WG.<a href="#section-3.8-1" class="pilcrow">¶</a></p>
<p id="section-3.8-2">Each KeyPackage that a client publishes also carries a FanoutAuthToken inside
a FanoutAuth KeyPackage extension.<a href="#section-3.8-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.8-3">
<pre>
struct {
  opaque token&lt;V&gt;;
} FanoutAuthToken
</pre><a href="#section-3.8-3" class="pilcrow">¶</a>
</div>
<p id="section-3.8-4">Whenever a client is added to a group (or when a new group is created), the DS
checks that the KeyPackages of all joiners contain a FanoutAuth extension and
stores the contained token alongside the group state.<a href="#section-3.8-4" class="pilcrow">¶</a></p>
<p id="section-3.8-5">The FanoutAuthToken is included in DSFanoutRequests and allows the receiving
DS to check whether the sender is authorized to enqueue messages for the
recipient.<a href="#section-3.8-5" class="pilcrow">¶</a></p>
<p id="section-3.8-6">Clients can change their FanoutAuthToken by sending a new token with an
update operation.<a href="#section-3.8-6" class="pilcrow">¶</a></p>
<p id="section-3.8-7">TODO: Details on the cryptographic scheme underlying the token.<a href="#section-3.8-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="clients-and-users">
<section id="section-3.9">
        <h3 id="name-clients-and-users">
<a href="#section-3.9" class="section-number selfRef">3.9. </a><a href="#name-clients-and-users" class="section-name selfRef">Clients and users</a>
        </h3>
<p id="section-3.9-1">TODO: This section needs to be revisited once identifiers and client/user
authentication in general have been decided on by the MIMI WG.<a href="#section-3.9-1" class="pilcrow">¶</a></p>
<p id="section-3.9-2">TODO: This topic is still under discussion, so this section only represents a
suggestion for an MLS-based flow. Once we have more clarity on what participant
data management looks like, we will update all other relevant sections of this
document.<a href="#section-3.9-2" class="pilcrow">¶</a></p>
<p id="section-3.9-3">Each MIMI-DS managed group contains a MIMIParticipantExtension as part of its
GroupContext. The MIMIParticipantExtension contains a participant list, i.e. all
users that are associated with the group. Note that this includes inactive
participants.<a href="#section-3.9-3" class="pilcrow">¶</a></p>
<p id="section-3.9-4">TODO: This extension can later be extended by also containing the roles of the
participants to facilitate RBAC.<a href="#section-3.9-4" class="pilcrow">¶</a></p>
<p id="section-3.9-5">The participant list is changed via MIMIParticipant proposals, which can be
issued by clients or servers and that can be the committed by clients as part of
client-initiated operations as specified in <a href="#operations" class="auto internal xref">Section 10</a>. Each
MIMIParticpipant proposal can add, remove or update a user's record in the
MIMIParticipantExtension. The data in the extension MUST be consistent with the
membership data of the MLS group.<a href="#section-3.9-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="version-agility">
<section id="section-3.10">
        <h3 id="name-version-agility">
<a href="#section-3.10" class="section-number selfRef">3.10. </a><a href="#name-version-agility" class="section-name selfRef">Version agility</a>
        </h3>
<p id="section-3.10-1">MLS provides version, ciphersuite and extension agility. The versions,
ciphersuites and extensions a client supports are advertised in its LeafNodes,
both in all of the client's groups, as well as in its KeyPackages through the
Capabilities field (Section 7.2 of <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span>).<a href="#section-3.10-1" class="pilcrow">¶</a></p>
<p id="section-3.10-2">MLS DS protocol clients MUST make use of a LeafNode extension to advertise the
MIMI DS protocol versions they support.<a href="#section-3.10-2" class="pilcrow">¶</a></p>
<p id="section-3.10-3">TODO: Such an extension would have to be specified in the context of the MLS WG.<a href="#section-3.10-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="group-lifecycle">
<section id="section-3.11">
        <h3 id="name-group-lifecycle">
<a href="#section-3.11" class="section-number selfRef">3.11. </a><a href="#name-group-lifecycle" class="section-name selfRef">Group lifecycle</a>
        </h3>
<p id="section-3.11-1">Upon creation MLS groups are parameterized by a GroupID, an MLS version number,
as well as a ciphersuite. All three parameters are fixed and cannot be changed
throughout the lifetime of a group.<a href="#section-3.11-1" class="pilcrow">¶</a></p>
<p id="section-3.11-2">Groups capable of interoperability with the MIMI DS protocol MUST use a
GroupContext extension that indicates the MIMI DS protocol version with which it
was created. This extension MUST NOT be changed throughout the lifetime of the
group.<a href="#section-3.11-2" class="pilcrow">¶</a></p>
<p id="section-3.11-3">While all these parameters cannot be changed throughout a group's lifetime, the
group can be re-initialized as described in Section 11.2. of
<span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span> to create a new group with a new set of parameters.<a href="#section-3.11-3" class="pilcrow">¶</a></p>
<p id="section-3.11-4">The MIMI DS protocol supports re-initializations of groups using the
corresponding ReInitialization operation under the condition that all MLS
parameters are compatible with the MIMI DS protocol version.<a href="#section-3.11-4" class="pilcrow">¶</a></p>
<p id="section-3.11-5">If a group is no longer used, it can be deleted either by a client or the DS
itself.<a href="#section-3.11-5" class="pilcrow">¶</a></p>
<p id="section-3.11-6">TODO: Each MIMI DS protocol version should probably fix a set of ciphersuites,
MLS protocol versions and maybe even extensions it supports. New ones can be
added with protocol version upgrades.<a href="#section-3.11-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-properties-overview">
<section id="section-4">
      <h2 id="name-security-properties-overvie">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-security-properties-overvie" class="section-name selfRef">Security properties overview</a>
      </h2>
<p id="section-4-1">The MIMI DS protocol provides a number of security guarantees.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div id="mls-based-security-properties">
<section id="section-4.1">
        <h3 id="name-mls-based-security-properti">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-mls-based-security-properti" class="section-name selfRef">MLS-based security properties</a>
        </h3>
<p id="section-4.1-1">The MLS protocol underlying the MIMI DS protocol provides a number of security
guarantees that primarily affect end-to-end communication between clients such
as authentication and confidentiality with forward- as well as post-compromise
security (although the latter only holds for application messages). While the
MIMI DS protocol acts as a layer around the MLS protocol it inherits some of
MLSs security guarantees.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">More concretely, the DS can verify client signatures on MLS messages and thus
ensure that end-to-end authentication holds. Since the DS uses MLS messages to
track the group state (including group membership), it is guaranteed to have the
same view of that state as the group members.<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1-3">Finally, the MIMI DS protocol also makes use of the authenticated channel
provided by MLS to verify the authenticity of relevant extension data such as
the FanoutAuth tokens used for queue authorization.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="queue-authorization">
<section id="section-4.2">
        <h3 id="name-queue-authorization">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-queue-authorization" class="section-name selfRef">Queue Authorization</a>
        </h3>
<p id="section-4.2-1">When a client from a guest DS joins a group, it provides the hub with a
FanoutAuth token. The hub can then use that token to prove to the guest DS
that it is authorized to deliver messages to the queue of that client.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="framing-and-processing-overview">
<section id="section-5">
      <h2 id="name-framing-and-processing-over">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-framing-and-processing-over" class="section-name selfRef">Framing and processing overview</a>
      </h2>
<div id="client-to-server-requests">
<section id="section-5.1">
        <h3 id="name-client-to-server-requests">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-client-to-server-requests" class="section-name selfRef">Client to server requests</a>
        </h3>
<p id="section-5.1-1">All client to server requests consist of a MIMI DS specific protocol wrapper
called DSRequst. DSRequest contains the MIMI DS protocol version, a body with
operation-specific data, as well as authentication information.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-2">
<pre>
enum {
  ds_request_group_id(0),
  ds_create_group(1),
  ds_delete_group(2),
  ...
} DSRequestType;

struct {
  DSRequestType request_type;
  select (DSRequestBody.request_type) {
    case ds_delete_group:
      DeleteGroupRequest delete_group_request;
    ...
  }
} DSRequestBody;

struct {
  DSProtocolVersion version;
  DSRequestBody request_body;
  DSAuthData authentication_data;
} DSRequest;
</pre><a href="#section-5.1-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1-3">A DS supports a variety of operations. For presentational reasons, we only
define DSRequestType and the corresponding <code>case</code> statement in DSRequestBody
partially here. The full definition with all operations relevant for the
normal DS operating mode can be found in <a href="#operations" class="auto internal xref">Section 10</a>.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">The <code>authentication_data</code> field of a DSRequest depends on the request type and
contains the data necessary for the DS to authenticate the request.<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-5">
<pre>
enum {
  Anonymous,
  ClientSignature,
} DSAuthType;

struct {
  DSAuthType auth_type;
  select (DSAuthData.auth_type) {
    case Anonymous:
      struct {};
    case ClientSignature:
      uint32 sender_index;
      opaque signature&lt;0..255&gt;;
  }
} DSAuthData;
</pre><a href="#section-5.1-5" class="pilcrow">¶</a>
</div>
<p id="section-5.1-6">Before the DS performs the requested operation, it performs an authentication
operation depending on the DSAuthType.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-7.1">Anonymous: No authentication required<a href="#section-5.1-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-7.2">ClientSignature: The DS uses the public signature key of the MLS client in
leaf with the leaf index <code>sender_index</code> to verify the signature over the
following struct:<a href="#section-5.1-7.2" class="pilcrow">¶</a>
</li>
        </ul>
<div class="alignLeft art-text artwork" id="section-5.1-8">
<pre>
struct {
  DSProtocolVersion protocol_version;
  DSRequestBody request_body;
  u32 sender_index
} ClientSignatureTBS
</pre><a href="#section-5.1-8" class="pilcrow">¶</a>
</div>
<p id="section-5.1-9">Note that all group operations additionally contain an MLSMessage the content
of which mirrors the request type, e.g., an AddUsers request wraps an MLS commit
that in turn contains the Add proposals for the users' clients. In that case,
the DS uses the GroupID inside the MLSMessage to determine which group the
request refers to and verifies the MLSMessage in the same way an MLS client
would (including the signature).<a href="#section-5.1-9" class="pilcrow">¶</a></p>
<p id="section-5.1-10">Depending on the nature of the request, clients can also include data in the AAD
field of the MLSMessage, where it can be read and authenticated by both DS and
all other group members.<a href="#section-5.1-10" class="pilcrow">¶</a></p>
<p id="section-5.1-11">After performing the desired operation using the data in DSRequestBody the DS
responds to the client (or the proxying guest DS) with a DSResponse.<a href="#section-5.1-11" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-12">
<pre>
struct {
  DSProtocolVersion protocol_version;
  DSResponseBody response_body;
} DSResponse

enum DSResponseType {
  Ok,
  Error,
  GroupID,
  WelcomeInfo,
  ExternalCommitInfo
  SignaturePublicKey,
  KeyPackages,
  ConnectionKeyPackages,
}

struct DSResponseBody {
  DSResponseType response_type;
  select (DSResponseBody.response_type) {
    case Ok:
      struct {};
    case Error:
      DSError error;
    case GroupID:
      opaque group_id&lt;V&gt;;
    case WelcomeInfo:
      optional&lt;Node&gt; ratchet_tree&lt;V&gt;;
    case ExternalCommit:
      MLSMessage: group_info;
      optional&lt;Node&gt; ratchet_tree&lt;V&gt;;
    case SignaturePublicKey:
      SignaturePublicKey signature_public_key;
    case KeyPackages:
      KeyPackage key_packages&lt;V&gt;;
    case ConnectionKeyPackages:
      KeyPackage key_packages&lt;V&gt;;
  }
}

struct {
  TODO: Operation specific errors.
} DSError
</pre><a href="#section-5.1-12" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="server-to-server-requests">
<section id="section-5.2">
        <h3 id="name-server-to-server-requests">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-server-to-server-requests" class="section-name selfRef">Server to server requests</a>
        </h3>
<p id="section-5.2-1">After sending the response, and depending on the operation the DS might fan out
messages to one or more guest DSs.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">To that end, it wraps the MLSMessage to be fanned out into a DSFanoutRequest. In
addition to the MLSMessage, the DSFanoutRequest contains the protocol version, a
list of client ids representing the clients for which the payload is meant, a
FanoutAuthToken (see <a href="#enqueue-authorization" class="auto internal xref">Section 3.8</a>) for each of the clients, as well
as the payload to be fanned out.<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2-3">
<pre>
struct {
  DSProtocolVersion protocol_version;
  opaque recipient_ids&lt;V&gt;;
  FanoutAuthToken fanout_auth_tokens&lt;V&gt;;
  MLSMessage mls_message;
} DSFanoutRequest
</pre><a href="#section-5.2-3" class="pilcrow">¶</a>
</div>
<p id="section-5.2-4">The receiving DS first verifies the signature using the sending DS' public
signature key and then further validates the message by performing the following
checks:<a href="#section-5.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-5.1">That the protocol version is compatible with its configuration<a href="#section-5.2-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-5.2">That the <code>recipient_ids</code> are all clients of this DS<a href="#section-5.2-5.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-5.3">The the <code>fanout_auth_tokens</code> are all valid tokens for the individual
recipients<a href="#section-5.2-5.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.2-6">The recieving DS can then store and forward the contained MLS message to the
clients indicated in the <code>recipient_ids</code> field and send a DSFanoutResponse.<a href="#section-5.2-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2-7">
<pre>
enum {
  Ok,
  Error,
} DSFanoutResponseType

struct {
  TODO: Fanout error types
} DSFanoutError

struct DSFanoutResponseBody {
  DSFanoutResponseType response_type;
  select (DSFanoutResponseBody.response_type) {
    case Ok:
      struct {};
    case Error:
      DSFanoutError error;
  }
}

struct {
  DSProtocolVersion protocol_version;
  DSResponseBody response_body;
} DSFanoutResponse
</pre><a href="#section-5.2-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="keypackages-1">
<section id="section-5.3">
        <h3 id="name-keypackages-2">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-keypackages-2" class="section-name selfRef">KeyPackages</a>
        </h3>
<p id="section-5.3-1">As noted in <a href="#keypackages" class="auto internal xref">Section 3.7</a>, clients must upload KeyPackages such that other
clients can add them to groups.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="connection-establishment-flow">
<section id="section-6">
      <h2 id="name-connection-establishment-fl">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-connection-establishment-fl" class="section-name selfRef">Connection establishment flow</a>
      </h2>
<p id="section-6-1">A user can establish a connection to another user by creating a connection
group, fetching a connection KeyPackage of the target user's clients from its DS
and inviting that user to the connection group. The receiving user can process
the Welcome and figure out from the group state who the sender is. Additional
information can either be attached to the group via an extension, or via MLS
application messages within that group.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">TODO: This is a sketch for a simple connection establishment flow that allows
the recipient to identify and authenticate the sender and that establishes an
initial communication channel between the two users. More functionality can be
added via additional messages or MLS extensions.<a href="#section-6-2" class="pilcrow">¶</a></p>
<span id="name-example-flow-for-connection"></span><figure id="figure-4">
        <div id="section-6-3.1">
          <div class="alignLeft art-svg artwork" id="section-6-3.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="336" width="632" viewBox="0 0 632 336" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
              <path d="M 8,48 L 8,304" fill="none" stroke="black"></path>
              <path d="M 240,48 L 240,88" fill="none" stroke="black"></path>
              <path d="M 240,104 L 240,136" fill="none" stroke="black"></path>
              <path d="M 240,152 L 240,304" fill="none" stroke="black"></path>
              <path d="M 448,48 L 448,304" fill="none" stroke="black"></path>
              <path d="M 608,48 L 608,304" fill="none" stroke="black"></path>
              <path d="M 8,96 L 440,96" fill="none" stroke="black"></path>
              <path d="M 16,144 L 448,144" fill="none" stroke="black"></path>
              <path d="M 8,192 L 232,192" fill="none" stroke="black"></path>
              <path d="M 8,240 L 232,240" fill="none" stroke="black"></path>
              <path d="M 240,256 L 440,256" fill="none" stroke="black"></path>
              <path d="M 448,272 L 600,272" fill="none" stroke="black"></path>
              <polygon class="arrowhead" points="608,272 596,266.4 596,277.6" fill="black" transform="rotate(0,600,272)"></polygon>
              <polygon class="arrowhead" points="448,256 436,250.4 436,261.6" fill="black" transform="rotate(0,440,256)"></polygon>
              <polygon class="arrowhead" points="448,96 436,90.4 436,101.6" fill="black" transform="rotate(0,440,96)"></polygon>
              <polygon class="arrowhead" points="240,240 228,234.4 228,245.6" fill="black" transform="rotate(0,232,240)"></polygon>
              <polygon class="arrowhead" points="240,192 228,186.4 228,197.6" fill="black" transform="rotate(0,232,192)"></polygon>
              <polygon class="arrowhead" points="24,144 12,138.4 12,149.6" fill="black" transform="rotate(180,16,144)"></polygon>
              <g class="text">
                <text x="24" y="36">Alice</text>
                <text x="248" y="36">Hub</text>
                <text x="464" y="36">Guest</text>
                <text x="500" y="36">DS</text>
                <text x="616" y="36">Bob</text>
                <text x="48" y="68">Request</text>
                <text x="124" y="68">Connection</text>
                <text x="64" y="84">KeyPackages</text>
                <text x="60" y="132">Connection</text>
                <text x="152" y="132">KeyPackages</text>
                <text x="44" y="180">Create</text>
                <text x="116" y="180">Connection</text>
                <text x="184" y="180">group</text>
                <text x="32" y="228">Add</text>
                <text x="88" y="228">Responder</text>
                <text x="488" y="228">Deliver</text>
                <text x="552" y="228">Welcome</text>
                <text x="264" y="244">Fan</text>
                <text x="296" y="244">out</text>
                <text x="344" y="244">Welcome</text>
                <text x="508" y="244">(proprietary</text>
                <text x="504" y="260">protocol)</text>
              </g>
            </svg><a href="#section-6-3.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-example-flow-for-connection" class="selfRef">Example flow for connection establishment</a>
        </figcaption></figure>
</section>
</div>
<div id="ds-assisted-joining">
<section id="section-7">
      <h2 id="name-ds-assisted-joining">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-ds-assisted-joining" class="section-name selfRef">DS assisted joining</a>
      </h2>
<p id="section-7-1">To verify and deliver messages, authenticate clients as members of a group and
to assist clients that want to join a group, the DS keeps track of the state of
each group for which it is the hub. More specifically, it keeps track of the
group's ratchet tree, the group's GroupContext and other information required to
produce a valid GroupInfo for the current group epoch. It does this by
processing incoming MLS messages in the same way a member of that group would,
except of course that the DS doesn't hold any private key material.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">While MLS messages are sufficient to keep track of most of the group information,
it is not quite enough to create a GroupInfo. To allow the DS to provide a valid
GroupInfo to externally joining clients, it additionally requires clients to
provide the remaining required information. Concretely, it requires clients to
upload the Signature and the GroupInfo extensions. Clients need to send this
information whenever they send an MLS message (i.e. an MLSMessage struct) that
contains a commit.<a href="#section-7-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7-3">
<pre>
struct {
  Extension group_info_extensions&lt;V&gt;;
  opaque Signature&lt;V&gt;;
} PartialGroupInfo
</pre><a href="#section-7-3" class="pilcrow">¶</a>
</div>
<p id="section-7-4">The combination of a commit and a partial group info is called an
MLSGroupUpdate.<a href="#section-7-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7-5">
<pre>
struct {
  MLSMessage commit;
  PartialGroupInfo partial_group_info;
} MLSGroupUpdate
</pre><a href="#section-7-5" class="pilcrow">¶</a>
</div>
<p id="section-7-6">Whenever the DS receives an MLSGroupUpdate, it must verify that the
MLSMessage contains a PublicMessage with a commit and that commit and partial
group info are valid relative to the existing group state according to the MLS
specification.<a href="#section-7-6" class="pilcrow">¶</a></p>
<p id="section-7-7">TODO: For now there is no distinct endpoint to obtain authentication material
that allows the DS to authenticate clients. This would be part of the AS design.<a href="#section-7-7" class="pilcrow">¶</a></p>
<p id="section-7-8">By tracking the group information in this way, the DS can help clients that join
via external commit by providing them with a ratchet tree and a group into.<a href="#section-7-8" class="pilcrow">¶</a></p>
<p id="section-7-9">Similary, clients that wish to join a group via a regular invite (i.e. a Welcome
message) have already received a GroupInfo and can obtain a ratchet tree from
the DS.<a href="#section-7-9" class="pilcrow">¶</a></p>
<p id="section-7-10">In the time between a client being added to a group by a commit and the client
wanting to join the group, the group state can have progressed by one or more
epochs. As a consequence, the DS MUST keep track of epochs in which clients are
added and store the corresponding group states until each client has
successfully joined.<a href="#section-7-10" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proposals-by-reference">
<section id="section-8">
      <h2 id="name-proposals-and-ds-initiated-">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-proposals-and-ds-initiated-" class="section-name selfRef">Proposals and DS-initiated operations</a>
      </h2>
<p id="section-8-1">MLS relies on a proposal-commit logic, where the proposals encode the specific
action the sending client intends to take and the commit then performs the
actions of a set of commits.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">The advantage of this approach is that the sender of the proposal does not have
to be the committer, which allows, for example, the DS to propose the removal of
a client, or a client to propose that it be removed from the group. Note that
the latter example is the only way that a client can remove itself (i.e. leave)
from a group.<a href="#section-8-2" class="pilcrow">¶</a></p>
<p id="section-8-3">Such proposals, where the original sender differs from the sender of the commit
are called "proposal by reference", or "proposal by value" if the proposal is
sent by the committer as part of the commit itself.<a href="#section-8-3" class="pilcrow">¶</a></p>
<p id="section-8-4">The following sections detail operations that can be performed by clients, so
each operation that entails a change to the group state (with the exception of
the self remove operation) require the sender to perform a commit, where the
semantics of the operation are reflected as proposals by value. For example, the
commit in the AddUsersRequest must only contain Add proposals.<a href="#section-8-4" class="pilcrow">¶</a></p>
<p id="section-8-5">If a client receives a valid standalone proposal, it MUST store it and verify
that the next commit includes said proposal.<a href="#section-8-5" class="pilcrow">¶</a></p>
<p id="section-8-6">TODO: Be more specific about proposal validation. Also, we might want to allow
the server to rescind a proposal.<a href="#section-8-6" class="pilcrow">¶</a></p>
<p id="section-8-7">Whenever a client sends a commit as part of an operation, it MUST include all
stored proposals by reference, such as server-initiated Remove proposals, or proposals sent
as part of a self-remove operation.<a href="#section-8-7" class="pilcrow">¶</a></p>
<p id="section-8-8">TODO: Proposals by reference pose a problem in the context of external commits,
as, even if the external committer had access to all proposals in an epoch, it
wouldn't be able to verify them, thus potentially leading to an invalid external
commit. A solution could be introduced either as part of the MIMI DS protocol,
or as an MLS extension. The latter would be preferable, as other users of MLS
are likely going to encounter the same problem.<a href="#section-8-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ds-operations">
<section id="section-9">
      <h2 id="name-ds-initiated-operations">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-ds-initiated-operations" class="section-name selfRef">DS-initiated operations</a>
      </h2>
<p id="section-9-1">While the nature of MLS prevents the DS from performing changes to the group
state itself, it can propose that clients perform certain actions and enforce
the enactment of such proposals.<a href="#section-9-1" class="pilcrow">¶</a></p>
<p id="section-9-2">To allow the DS to send proposals, all groups MUST contain an <code>external_senders</code>
extension as defined in Section 12.1.8.1. of <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span> that
includes the DS' credential and its signature public key.<a href="#section-9-2" class="pilcrow">¶</a></p>
<p id="section-9-3">TODO: We might also want to mandate that the group includes credentials of guest
DSs involved in the group. However, for them to be able to send proposals, we'd
need an additional operation/endpoint that the DS exposes.<a href="#section-9-3" class="pilcrow">¶</a></p>
<p id="section-9-4">TODO: Details of the DS credential. A BasicCredential
with the FQDN of the DS would probably be sufficient.<a href="#section-9-4" class="pilcrow">¶</a></p>
<p id="section-9-5">The DS can simply create such proposals itself based on the group information
and distribute it to all group members via regular DSFanoutRequests.<a href="#section-9-5" class="pilcrow">¶</a></p>
<div id="client-removals">
<section id="section-9.1">
        <h3 id="name-client-removals">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-client-removals" class="section-name selfRef">Client removals</a>
        </h3>
<p id="section-9.1-1">The DS can propose that one or more clients be removed from a given group. To
that end, it issues a remove proposal for each client it wants removed, where
each remove proposal targets the leaf of one of the clients in question.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="client-additions">
<section id="section-9.2">
        <h3 id="name-client-additions">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-client-additions" class="section-name selfRef">Client additions</a>
        </h3>
<p id="section-9.2-1">The DS can propose that one or more clients be added to the group. It does so by
issueing an add proposal for each client, where each add proposal contains a
KeyPackage of the respective client.<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<p id="section-9.2-2">TODO: If the DS should be allowed to add clients that belong to another DS, we
need an endpoint that allows DSs to fetch KeyPackages from one-another.<a href="#section-9.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="operations">
<section id="section-10">
      <h2 id="name-client-initiated-operations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-client-initiated-operations" class="section-name selfRef">Client-initiated operations</a>
      </h2>
<p id="section-10-1">The DS supports a number of operations, each of which is represented by a
variant of the DSRequestType enum and has its own request body.<a href="#section-10-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10-2">
<pre>
enum {
  ds_request_group_id(0),
  ds_create_group(1),
  ds_delete_group(2),
  ds_add_users(3),
  ds_remove_users(4),
  ds_add_clients(5),
  ds_remove_clients(6),
  ds_self_remove_client(7),
  ds_update_client(8),
  ds_external_join(9),
  ds_send_message(10),
  ds_signature_public_key(11),
  ds_key_packages(12),
  ds_connection_key_packages(13),
  ds_re_initialize_group(14),
} DSRequestType;

struct {
  DSRequestType request_type;
  select (DSRequestBody.request_type) {
    case ds_request_group_id:
      struct {};
    case ds_create_group:
      CreateGroupRequest create_group_request;
    case ds_delete_group:
      DeleteGroupRequest delete_group_request;
    case ds_add_users:
      AddUsersRequest add_users_request;
    case ds_remove_users:
      RemoveUsersRequest remove_users_request;
    case ds_add_clients:
      AddClientsRequest add_clients_request;
    case ds_remove_clients:
      RemoveClientsRequest remove_clients_request;
    case ds_self_remove_clients:
      SelfRemoveClientsRequest self_remove_clients_request;
    case ds_update_client:
      UpdateClientRequest update_client_request;
    case ds_external_join:
      ExternalJoinRequest external_join_request;
    case ds_send_message:
      SendMessageRequest send_message_request;
    case ds_signature_public_key:
      struct {};
    case ds_key_packages:
      KeyPackagesRequest key_packages_request;
    case ds_connection_key_packages:
      ConnectionKeyPackagesRequest connection_key_packages_request;
    case ds_re_initialize_group:
      ReInitializeGroupRequest re_initialize_group_request;
  }
} DSRequestBody;
</pre><a href="#section-10-2" class="pilcrow">¶</a>
</div>
<div id="request-group-id">
<section id="section-10.1">
        <h3 id="name-request-group-id">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-request-group-id" class="section-name selfRef">Request group id</a>
        </h3>
<p id="section-10.1-1">Clients can use this operation to request a group id. This group ID can
subsequently used to create a group on this DS.<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<p id="section-10.1-2">After receiving this request, the DS generates a unique group id and responds
with a DSResponse struct of type GroupID.<a href="#section-10.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="create-group">
<section id="section-10.2">
        <h3 id="name-create-group">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-create-group" class="section-name selfRef">Create group</a>
        </h3>
<p id="section-10.2-1">A request from the client to create a new group on the Delivery Service. This
operation can be used both for the creation of regular groups and for the
creation of connection groups.<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<p id="section-10.2-2">The client sends the following CreateGroupRequest to the Delivery Service:<a href="#section-10.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.2-3">
<pre>
struct {
  opaque group_id&lt;V&gt;;
  LeafNode LeafNode;
  MLSMessage group_info;
} CreateGroupRequest;
</pre><a href="#section-10.2-3" class="pilcrow">¶</a>
</div>
<p id="section-10.2-4">The Delivery Service internally creates and stores the group based on the
information in the request and responds with a CreateGroupResponse:<a href="#section-10.2-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.2-5">
<pre>
enum {
  invalid_group_id(0),
  invalid_leaf_node(1),
  invalid_group_info(2),
} CreateGroupResponse;
</pre><a href="#section-10.2-5" class="pilcrow">¶</a>
</div>
<p id="section-10.2-6">TODO: How to mark connection groups? Have the creator include a connection
extension in the LeafNode?<a href="#section-10.2-6" class="pilcrow">¶</a></p>
<p id="section-10.2-7"><strong>Validation:</strong><a href="#section-10.2-7" class="pilcrow">¶</a></p>
<p id="section-10.2-8">The Delivery Service validates the request as follows:<a href="#section-10.2-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-9.1">The group ID MUST NOT be not empty and MUST NOT already be in use.<a href="#section-10.2-9.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-9.2">The LeafNode MUST be valid, according to <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span> 7.3. Leaf
Node validation.<a href="#section-10.2-9.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-9.3">The GroupInfo MUST be valid, according to <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span> 12.4.3.
Adding Members to the Group.<a href="#section-10.2-9.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="delete-group">
<section id="section-10.3">
        <h3 id="name-delete-group">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-delete-group" class="section-name selfRef">Delete group</a>
        </h3>
<p id="section-10.3-1">A request from the client to delete a group from the Delivery Service. This
operation allows clients to delete a group from the DS. Clients can of course
keep a copy of the group state locally for archival purposes.<a href="#section-10.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.3-2">
<pre>
struct {
  MLSGroupUpdate group_update;
} DeleteGroupRequest;
</pre><a href="#section-10.3-2" class="pilcrow">¶</a>
</div>
<p id="section-10.3-3"><strong>Validation:</strong><a href="#section-10.3-3" class="pilcrow">¶</a></p>
<p id="section-10.3-4">The Delivery Service validates the request as follows:<a href="#section-10.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.3-5.1">The MLSGroupUpdate MUST contain a PublicMessage with a commit that contains
Remove proposals for every member of the group except the committer.<a href="#section-10.3-5.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="add-users-to-a-group">
<section id="section-10.4">
        <h3 id="name-add-users-to-a-group">
<a href="#section-10.4" class="section-number selfRef">10.4. </a><a href="#name-add-users-to-a-group" class="section-name selfRef">Add users to a group</a>
        </h3>
<p id="section-10.4-1">A request from a client to add one or more users to a group. For each user, one
or more of the user's clients are added to the group. The Welcome messages in
the request are then fanned out to the user's DSs.<a href="#section-10.4-1" class="pilcrow">¶</a></p>
<p id="section-10.4-2">To obtain the KeyPackages required to add the users' clients, the sender must
first fetch the clients' KeyPackages from their DS.<a href="#section-10.4-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.4-3">
<pre>
struct {
  MLSGroupUpdate group_update;
  MLSMessage welcome_messages&lt;V&gt;;
} AddUsersRequest;
</pre><a href="#section-10.4-3" class="pilcrow">¶</a>
</div>
<p id="section-10.4-4"><strong>Validation:</strong><a href="#section-10.4-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.4-5.1">The MLSGroupUpdate in the <code>commit</code> field MUST contain a PublicMessage with a
commit that contains only Add proposals with the possible exception of Remove
proposals as detailed in <a href="#proposals-by-reference" class="auto internal xref">Section 8</a>.<a href="#section-10.4-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.4-5.2">The commit MUST NOT change the sender's client credential.<a href="#section-10.4-5.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.4-5.3">Add proposals MUST NOT contain clients of existing group members.<a href="#section-10.4-5.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.4-5.4">Add proposals MUST NOT contain connection KeyPackages, except if the group is
a connection group.<a href="#section-10.4-5.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.4-5.5">If guest users are added as part of the request, there MUST be a distinct
Welcome message for each guest DS involved.<a href="#section-10.4-5.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.4-5.6">All KeyPackages included in Add proposals MUST include a FanoutAuth extension.<a href="#section-10.4-5.6" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="remove-users-from-a-group">
<section id="section-10.5">
        <h3 id="name-remove-users-from-a-group">
<a href="#section-10.5" class="section-number selfRef">10.5. </a><a href="#name-remove-users-from-a-group" class="section-name selfRef">Remove users from a group</a>
        </h3>
<p id="section-10.5-1">A request from a client to remove one or more users from a group. The DS will
still fan out the request to the users. The commit contained in the message will
allow the users to recognize that they were removed.<a href="#section-10.5-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.5-2">
<pre>
struct {
  MLSGroupUpdate group_update;
} RemoveUsersRequest;
</pre><a href="#section-10.5-2" class="pilcrow">¶</a>
</div>
<p id="section-10.5-3"><strong>Validation:</strong><a href="#section-10.5-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.5-4.1">The MLSGroupUpdate MUST contain a PublicMessage with a commit that contains
only Remove proposals (see also <a href="#proposals-by-reference" class="auto internal xref">Section 8</a>).<a href="#section-10.5-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.5-4.2">The commit MUST NOT change the sender's client credential.<a href="#section-10.5-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.5-4.3">The Remove proposals that are committed by-value MUST always remove all
clients of one or more users.<a href="#section-10.5-4.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="add-clients-to-a-group">
<section id="section-10.6">
        <h3 id="name-add-clients-to-a-group">
<a href="#section-10.6" class="section-number selfRef">10.6. </a><a href="#name-add-clients-to-a-group" class="section-name selfRef">Add clients to a group</a>
        </h3>
<p id="section-10.6-1">A request from a client to add one or more clients of the same user. This
operation allows users to add new clients to an existing group. Alternatively,
new clients can add themselves by joining via external commit.<a href="#section-10.6-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.6-2">
<pre>
struct {
  MLSGroupUpdate group_update;
  MLSMessage welcome_messages&lt;V&gt;;
} AddClientsRequest;
</pre><a href="#section-10.6-2" class="pilcrow">¶</a>
</div>
<p id="section-10.6-3"><strong>Validation:</strong><a href="#section-10.6-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.6-4.1">The MLSGroupUpdate MUST contain a PublicMessage with a commit that contains
only Add proposals with the possible exception of Remove proposals as detailed
in <a href="#proposals-by-reference" class="auto internal xref">Section 8</a>.<a href="#section-10.6-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.6-4.2">The commit MUST NOT change the sender's client credential.<a href="#section-10.6-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.6-4.3">All Add proposals MUST contain clients of the same user as an existing group
member.<a href="#section-10.6-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.6-4.4">All KeyPackages included in Add proposals MUST include a FanoutAuth extension.<a href="#section-10.6-4.4" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="remove-clients-from-a-group">
<section id="section-10.7">
        <h3 id="name-remove-clients-from-a-group">
<a href="#section-10.7" class="section-number selfRef">10.7. </a><a href="#name-remove-clients-from-a-group" class="section-name selfRef">Remove clients from a group</a>
        </h3>
<p id="section-10.7-1">A request from a client to remove one or more other clients of the same user
from a group. This operation allows users to remove their own clients from a
group. Note that this operation cannot be used by a client to remove itself from
the group. For that purpose, the SelfRemoveClientRequest should be used instead.<a href="#section-10.7-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.7-2">
<pre>
struct {
  MLSGroupUpdate group_update;
} RemoveClientsRequest;
</pre><a href="#section-10.7-2" class="pilcrow">¶</a>
</div>
<p id="section-10.7-3"><strong>Validation:</strong><a href="#section-10.7-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.7-4.1">The MLSGroupUpdate MUST contain a PublicMessage with a commit that contains only
Remove proposals.<a href="#section-10.7-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.7-4.2">The commit MUST NOT change the sender's client credential.<a href="#section-10.7-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.7-4.3">All Remove proposals committed to by-value MUST target clients of the same
user as the sending client<a href="#section-10.7-4.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="self-remove-a-client-from-a-group">
<section id="section-10.8">
        <h3 id="name-self-remove-a-client-from-a">
<a href="#section-10.8" class="section-number selfRef">10.8. </a><a href="#name-self-remove-a-client-from-a" class="section-name selfRef">Self remove a client from a group</a>
        </h3>
<p id="section-10.8-1">A request from a client to remove itself from the group. If it's the last client
of a user, this effectively removes the user from the group. Note that this
request only contains a proposal, so the client is not effectively removed from
the group until another group member commits that proposal. See
<a href="#proposals-by-reference" class="auto internal xref">Section 8</a> for more details.<a href="#section-10.8-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.8-2">
<pre>
struct {
  MLSMessage proposal;
} SelfRemoveClientRequest;
</pre><a href="#section-10.8-2" class="pilcrow">¶</a>
</div>
<p id="section-10.8-3"><strong>Validation:</strong><a href="#section-10.8-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.8-4.1">The MLSMessage MUST contain a PublicMessage that contains a single
Remove proposal.<a href="#section-10.8-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.8-4.2">The Remove proposal MUST target the sending client.<a href="#section-10.8-4.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="update-a-client-in-a-group">
<section id="section-10.9">
        <h3 id="name-update-a-client-in-a-group">
<a href="#section-10.9" class="section-number selfRef">10.9. </a><a href="#name-update-a-client-in-a-group" class="section-name selfRef">Update a client in a group</a>
        </h3>
<p id="section-10.9-1">A request from a client to update its own leaf in an MLS group. This operation
can be used to update any information in the sender's leaf node. For example,
the sender could use this operation to update its key material to achieve
post-compromise security, update its Capabilities extension, or its leaf
credential.<a href="#section-10.9-1" class="pilcrow">¶</a></p>
<p id="section-10.9-2">The sending client can also choose to send a FanoutAuthToken, which the DS uses
to replace the client's existing token.<a href="#section-10.9-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.9-3">
<pre>
struct {
  MLSGroupUpdate group_update;
  optional&lt;FanoutAuthToken&gt; token;
} UpdateClientRequest;
</pre><a href="#section-10.9-3" class="pilcrow">¶</a>
</div>
<p id="section-10.9-4"><strong>Validation:</strong><a href="#section-10.9-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.9-5.1">The MLSGroupUpdate MUST contain a PublicMessage that contains a commit with an
UpdatePath, but no other proposals by value.<a href="#section-10.9-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.9-5.2">If the leaf credential is changed by the update, the DS MUST validate the new
credential.<a href="#section-10.9-5.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.9-6">TODO: The discussion around identity and credentials should yield a method to
judge if a new credential is a valid update to an existing one.<a href="#section-10.9-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="join-the-group-using-an-external-commit">
<section id="section-10.10">
        <h3 id="name-join-the-group-using-an-ext">
<a href="#section-10.10" class="section-number selfRef">10.10. </a><a href="#name-join-the-group-using-an-ext" class="section-name selfRef">Join the group using an external commit</a>
        </h3>
<p id="section-10.10-1">A request from a client to join a group using an external commit, i.e. without
the help of an existing group member. This operation can be used, for example,
by new clients of a user that already has clients in the group, or by existing
group members that have to recover from state loss.<a href="#section-10.10-1" class="pilcrow">¶</a></p>
<p id="section-10.10-2">To retrieve the information necessary to create the external commit, the joiner
has to fetch the external commit information from the DS.<a href="#section-10.10-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.10-3">
<pre>
struct {
  MLSGroupUpdate group_update;
} ExternalJoinRequest;
</pre><a href="#section-10.10-3" class="pilcrow">¶</a>
</div>
<p id="section-10.10-4"><strong>Validation:</strong><a href="#section-10.10-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.10-5.1">The MLSGroupUpdate MUST contain a PublicMessage that contains a commit with sender
type NewMemberCommit.<a href="#section-10.10-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.10-5.2">The sender of the ExternalJoinRequest MUST be a client that belongs to a user
that is already in the group.<a href="#section-10.10-5.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="send-an-application-message-to-a-group">
<section id="section-10.11">
        <h3 id="name-send-an-application-message">
<a href="#section-10.11" class="section-number selfRef">10.11. </a><a href="#name-send-an-application-message" class="section-name selfRef">Send an application message to a group</a>
        </h3>
<p id="section-10.11-1">A request from a client to fan out an application message to a group. This
operation is meant to send arbitrary data to the rest of the group. Since the
application message is a PrivateMessage, the DS can not verify its content or
authenticate its sender (even though it does authenticate the sender of the
surrounding DSRequest).<a href="#section-10.11-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.11-2">
<pre>
struct {
  MLSMessage application_message;
} SendMessageRequest;
</pre><a href="#section-10.11-2" class="pilcrow">¶</a>
</div>
<p id="section-10.11-3"><strong>Validation:</strong><a href="#section-10.11-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.11-4.1">The MLSMessage MUST contain a PrivateMessage with ContentType application.<a href="#section-10.11-4.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="fetch-the-ds-signature-public-key">
<section id="section-10.12">
        <h3 id="name-fetch-the-ds-signature-publ">
<a href="#section-10.12" class="section-number selfRef">10.12. </a><a href="#name-fetch-the-ds-signature-publ" class="section-name selfRef">Fetch the DS' signature public key</a>
        </h3>
<p id="section-10.12-1">A request from a remote DS to retrieve the signature public key of this DS. The
signature public key can be used by other DSs to verify DSFanoutRequests sent by
the DS. While the DS also uses its signature private key to sign proposals (see
<a href="#proposals-by-reference" class="auto internal xref">Section 8</a>), clients should use the signature key included in
the group's <code>external_senders</code> extension to validate those.<a href="#section-10.12-1" class="pilcrow">¶</a></p>
<p id="section-10.12-2">The DS responds with a DSResponse of type SignaturePublicKey that contains the
signature public key of this DS.<a href="#section-10.12-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="fetch-keypackages-of-one-or-more-clients">
<section id="section-10.13">
        <h3 id="name-fetch-keypackages-of-one-or">
<a href="#section-10.13" class="section-number selfRef">10.13. </a><a href="#name-fetch-keypackages-of-one-or" class="section-name selfRef">Fetch KeyPackages of one or more clients</a>
        </h3>
<p id="section-10.13-1">A request from a client to retrieve the KeyPackage(s) of one or more clients of
this DS. KeyPackages are required to add other clients (and thus other users) to
a group.<a href="#section-10.13-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.13-2">
<pre>
struct {
  ClientID client_identifiers&lt;V&gt;;
} KeyPackagesRequest;
</pre><a href="#section-10.13-2" class="pilcrow">¶</a>
</div>
<p id="section-10.13-3">The DS responds with the KeyPackages of all clients listed in the request.<a href="#section-10.13-3" class="pilcrow">¶</a></p>
<p id="section-10.13-4"><strong>Validation:</strong><a href="#section-10.13-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.13-5.1">All client identifiers MUST refer to clients native to this DS.<a href="#section-10.13-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.13-5.2">The DS SHOULD verify that the sender of the request is authorized to retrieve
the DSKeyPackages of the clients in question. For example, it could check if
the user of the sending client has a connection with the user of the target
client(s).<a href="#section-10.13-5.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="fetch-connection-keypackages-of-one-or-more-clients">
<section id="section-10.14">
        <h3 id="name-fetch-connection-keypackage">
<a href="#section-10.14" class="section-number selfRef">10.14. </a><a href="#name-fetch-connection-keypackage" class="section-name selfRef">Fetch connection KeyPackages of one or more clients</a>
        </h3>
<p id="section-10.14-1">A request from a client to retrieve the KeyPackage(s) of all clients of a user
of this DS. KeyPackages obtained via this operation can only be used to add
clients to a connection group.<a href="#section-10.14-1" class="pilcrow">¶</a></p>
<p id="section-10.14-2">Connection KeyPackages are available separately from regular KeyPackages, as
they are meant to be accessed by clients of users with which the owning user has
no connection.<a href="#section-10.14-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.14-3">
<pre>
struct {
  UserID user_identifier;
} ConnectionKeyPackagesRequest;
</pre><a href="#section-10.14-3" class="pilcrow">¶</a>
</div>
<p id="section-10.14-4">The DS responds with connection KeyPackages of all clients of the user
corresponding to the identifier in the request.<a href="#section-10.14-4" class="pilcrow">¶</a></p>
<p id="section-10.14-5"><strong>Validation:</strong><a href="#section-10.14-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.14-6.1">All client identifiers MUST refer to clients native to this DS.<a href="#section-10.14-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.14-6.2">All clients referred to by the identifiers MUST belong to the same user.<a href="#section-10.14-6.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="reinitialize-a-group">
<section id="section-10.15">
        <h3 id="name-reinitialize-a-group">
<a href="#section-10.15" class="section-number selfRef">10.15. </a><a href="#name-reinitialize-a-group" class="section-name selfRef">ReInitialize a group</a>
        </h3>
<p id="section-10.15-1">A request from a client to re-initialize a group with different parameters as
outlined in <a href="#group-lifecycle" class="auto internal xref">Section 3.11</a>.<a href="#section-10.15-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.15-2">
<pre>
struct {
  MLSGroupUpdate commit;
} ReInitializeGroupRequest;
</pre><a href="#section-10.15-2" class="pilcrow">¶</a>
</div>
<p id="section-10.15-3"><strong>Validation:</strong><a href="#section-10.15-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.15-4.1">The MLSGroupUpdate MUST contain a PublicMessage that contains a commit with a
re-init proposal.<a href="#section-10.15-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.15-4.2">The GroupID in the re-init proposal MUST point to another group on this hub,
which has a MIMI DS protocol version that is greater or equal than this group.<a href="#section-10.15-4.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="dsfanoutrequests-and-ds-to-ds-authentication">
<section id="section-11">
      <h2 id="name-dsfanoutrequests-and-ds-to-">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-dsfanoutrequests-and-ds-to-" class="section-name selfRef">DSFanoutRequests and DS-to-DS authentication</a>
      </h2>
<p id="section-11-1">After the DS has processed an incoming MLSMessage, it prepares a DSFanoutRequest
as described in <a href="#framing-and-processing-overview" class="auto internal xref">Section 5</a>.<a href="#section-11-1" class="pilcrow">¶</a></p>
<p id="section-11-2">To authenticate these messages, an additional layer of DS-to-DS authentication
is required. As defined in <a href="#framing-and-processing-overview" class="auto internal xref">Section 5</a>, DSFanoutRequests
are signed using signing key of the sending DS. The receiving DS can obtain the
corresponding signature public key by sending a DSRequest to the sender
indicated in the DSFanoutRequest.<a href="#section-11-2" class="pilcrow">¶</a></p>
<p id="section-11-3">The request for the signature public key MUST be sent via an HTTPS secured
channel, or otherwise authenticated using a root of trust present on the DS.<a href="#section-11-3" class="pilcrow">¶</a></p>
<p id="section-11-4">TODO: If the transport provides server-to-server authentication this section and
the signature on the DSFanoutRequest can be removed.
TODO: Details on key management, caching etc. We can probably get away with
using very small lifetimes for these keys, as they can be re-fetched cheaply and
essentially at any time.<a href="#section-11-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="role-based-access-control-in-groups">
<section id="section-12">
      <h2 id="name-role-based-access-control-i">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-role-based-access-control-i" class="section-name selfRef">Role-based access control in groups</a>
      </h2>
<p id="section-12-1">TODO: Access control is beyond the charter. However, to show how easily
implementable it is with MLS, this is section sketches a possible MLS extension
to handle access control in groups that is enforcible and verifiable by both
clients and DS. It is just an example and details can be changed later.<a href="#section-12-1" class="pilcrow">¶</a></p>
<p id="section-12-2">As group operations are handled by MLS PublicMessages, the DS can enforce access
control policies on groups. The privileges of clients in a group are determined
by the group's RBAC GroupContext Extension.<a href="#section-12-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12-3">
<pre>
struct {
  uint32 admins&lt;V&gt;;
} RBACExtension
</pre><a href="#section-12-3" class="pilcrow">¶</a>
</div>
<p id="section-12-4">The RBACExtension supports two roles: Members and Admins. Since all group
members are Members by default, the extension only lists admins.<a href="#section-12-4" class="pilcrow">¶</a></p>
<p id="section-12-5">Any client the leaf node index of which is listed in the <code>admins</code> field of the
RBACExtension in a given group is considered as an Admin role and allowed to
perform the following operations in the context of this group.<a href="#section-12-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12-6.1">AddUsers, RemoveUsers, DeleteGroup, SetRole<a href="#section-12-6.1" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-12-7">The SetRole operation is an additional operation available to groups that have
an RBACExtension.<a href="#section-12-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12-8">
<pre>
struct {
  MLSGroupUpdate group_update;
} SetRoleRequest
</pre><a href="#section-12-8" class="pilcrow">¶</a>
</div>
<p id="section-12-9">The <code>group_update</code> needs to contain a commit which commits to a single
RBACProposal.<a href="#section-12-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12-10">
<pre>
struct {
  uint32 promoted_members;
  uint32 demoted_members;
} SetRole
</pre><a href="#section-12-10" class="pilcrow">¶</a>
</div>
<p id="section-12-11">The DS (and all clients) process this proposal by changing the role of the group
members with the leaf indices listed in the <code>promoted_members</code> and
<code>demoted_members</code> fields and change the <code>admins</code> field of the group's
RBACExtension accordingly. For example, if the leaf index admin is listed in the
<code>changed_members</code> field of the proposal, it is demoted to Member and removed
from the <code>admins</code> field. Similarly, if a Member is listed, it is promoted to
Admin and added to the <code>admins</code> field.<a href="#section-12-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rate-limiting-and-spam-prevention">
<section id="section-13">
      <h2 id="name-rate-limiting-and-spam-prev">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-rate-limiting-and-spam-prev" class="section-name selfRef">Rate-limiting and spam prevention</a>
      </h2>
<p id="section-13-1">All requests (with the exception of the VerificationKeyRequest) can be
explicitly authenticated by the recipient through the verification of a
signature. This means that recipients can follow a rate-limiting strategy of
their choice based on the sender's identity.<a href="#section-13-1" class="pilcrow">¶</a></p>
<p id="section-13-2">For DSRequests, the DS can rate-limit on a per group-level, per-DS level
(reducing the messages from all clients or users belonging to a single DS), or
even based on individual clients or users.<a href="#section-13-2" class="pilcrow">¶</a></p>
<p id="section-13-3">For DSFanoutRequests, rate-limiting or blocking can happen based on the identity
of the sending DS, or it can happen on a per-group basis, where the recipient
only blocks messages from a particular group.<a href="#section-13-3" class="pilcrow">¶</a></p>
<p id="section-13-4">Such rate-limiting can happen by decision of the DS itself, or on the request of
its local users. For example, a user might wish to block connection requests
from one specific other user without blocking connection requests from all other
users of that DS.<a href="#section-13-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="abusive-and-illegal-content">
<section id="section-14">
      <h2 id="name-abusive-and-illegal-content">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-abusive-and-illegal-content" class="section-name selfRef">Abusive and illegal content</a>
      </h2>
<p id="section-14-1">As all application messages are encrypted, the DS has no way of analyzing their
content for illegal or abusive content. It may make use of a message franking
scheme to allow its users to report such content, although this is beyond the
scope of this document.<a href="#section-14-1" class="pilcrow">¶</a></p>
<p id="section-14-2">Additionally, in the same way as a DS might allow its users to block certain
messages from specific users in the context of spam prevention, it may do the
same based on abusive or illegal content.<a href="#section-14-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-15">
      <h2 id="name-security-considerations">
<a href="#section-15" class="section-number selfRef">15. </a><a href="#name-security-considerations" class="section-name selfRef">Security considerations</a>
      </h2>
<p id="section-15-1">TODO: There is currently no consensus in the MIMI w.r.t. the security goals we
want to reach.<a href="#section-15-1" class="pilcrow">¶</a></p>
<p id="section-15-2">The underlying MLS protocol provides end-to-end encryption and authentication
for all MLSMessages, as well as group state agreement.<a href="#section-15-2" class="pilcrow">¶</a></p>
<div id="transport-security">
<section id="section-15.1">
        <h3 id="name-transport-security">
<a href="#section-15.1" class="section-number selfRef">15.1. </a><a href="#name-transport-security" class="section-name selfRef">Transport Security</a>
        </h3>
<p id="section-15.1-1">Transport of DSFanoutRequests, as well as their responses MUST use a recipient
authenticated transport. This is to ensure that these messages are mutually
authenticated.<a href="#section-15.1-1" class="pilcrow">¶</a></p>
<p id="section-15.1-2">To protect the metadata in all request-response flows, requests and responses
SHOULD be secured using an encrypted transport channel.<a href="#section-15.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<section id="section-16">
      <h2 id="name-normative-references">
<a href="#section-16" class="section-number selfRef">16. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
      </h2>
<dl class="references">
<dt id="I-D.ietf-mls-protocol">[I-D.ietf-mls-protocol]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mls-protocol-20</span>, <time datetime="2023-03-27" class="refDate">27 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-protocol-20">https://datatracker.ietf.org/doc/html/draft-ietf-mls-protocol-20</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
    <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<div id="authors-addresses">
<section id="appendix-A">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
